@model MusiBuy.Common.Models.API.FrontUserViewModel
@using MusiBuy.Common.Common
@{
    ViewData["Title"] = "Edit Front User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="toolbar" id="kt_toolbar">
    <div class="container-fluid d-flex flex-stack flex-wrap flex-sm-nowrap">
        <div class="breadcrumb-header justify-content-between">
            <div class="left-content">
                <h1 class="main-content-title tx-24 mg-b-1 mg-b-lg-1">
                    Edit Front User
                    <small class="text-muted fs-6 fw-normal ms-1"></small>
                </h1>
                <partial name="_BreadCrumb" />
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <form asp-action="Edit" method="post" class="form-horizontal formstyle" id="frmUserEdit" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div id="display-messages"></div>
            @* <div id="duplicateRecord" class="validation-summary-errors d-none">
                <ul>
                    <li>
                        @Html.Encode(String.Format(Messages.CombinationExists, "Username", "User"))
                    </li>
                </ul>
            </div> *@
            <div id="duplicateEmailRecord" class="validation-summary-errors d-none">
                <ul>
                    <li>
                        @Html.Encode(String.Format(Messages.CombinationExists, "E-mail", "FrontUser"))
                    </li>
                </ul>
            </div>

            <div class="row">
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="FirstName">First name <span class="text-danger">*</span></label>
                        <input asp-for="FirstName" maxlength="50" onkeydown="return IsAlpha(event);" class="form-control" placeholder="First name" />
                        <span asp-validation-for="FirstName" class="text-danger"></span>
                        <input asp-for="Id" type="hidden" />
                    </div>
                </div>
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="LastName">Last name</label>
                        <input asp-for="LastName" maxlength="50" onkeydown="return IsAlpha(event);" class="form-control" placeholder="Last name" />
                        <span asp-validation-for="LastName" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12 col-lg-3">
                    <div class="form-group">
                        <label asp-for="UserTypeId">User Type <span class="text-danger">*</span></label>
                        <select asp-for="UserTypeId" asp-items="Model.SelectUserType" class="form-control borderfix">
                            <option value="" selected="selected">- Select User Type -</option>
                        </select>
                        <span asp-validation-for="UserTypeId" class="text-danger"></span>
                    </div>
                </div>
                 <div class="col-sm-12 col-lg-3">
                    <div class="form-group">
                        <label asp-for="RoleId">Role <span class="text-danger">*</span></label>
                        <select asp-for="RoleId" asp-items="Model.SelectRole" class="form-control borderfix">
                            <option value="" selected="selected">- Select role -</option>
                        </select>
                        <span asp-validation-for="RoleId" class="text-danger"></span>
                    </div>
                </div>
                
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="Email">Email <span class="text-danger">*</span></label>
                        <input asp-for="Email" maxlength="250" class="form-control" placeholder="Email" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                </div>

            </div>

          

            <div class="row">
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="Mobile">Phone <span class="text-danger">*</span></label>
                        <input asp-for="Mobile" class="form-control" maxlength="20" placeholder="Phone" onkeydown="return isNumberOnlyKey(this,event);" />
                        <span asp-validation-for="Mobile" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="Image">Profile picture </label>
                        <input type="file" asp-for="Image" class="form-control" accept=".jpg,.jpeg,.png,.bmp" />
                        <span asp-validation-for="Image" class="text-danger"></span>
                        <input type="hidden" asp-for="@Model.StrImage" />
                    </div>
                </div>
                <div id="image-preview" style="position:relative; margin-top:10px; @(Model.StrImage != null ? "" : "display:none;")">
                    <img id="image-preview-img"
                         src="@(Model.StrImage != null ? Url.Content(Model.StrImage) : "#")"
                         alt="Preview"
                         style="max-width:200px; max-height:200px; display:block; border:1px solid #ccc; padding:4px;" />
                    <button type="button"
                            id="remove-image"
                            style="position:absolute; top:0; background:rgba(0,0,0,0.6); color:#fff; border:none; border-radius:50%; width:24px; height:24px; line-height:20px; text-align:center; cursor:pointer;">
                        ×
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="Password">Password <span class="text-danger">*</span></label>
                        <input asp-for="Password" type="text" maxlength="50" class="form-control" placeholder="Password" />
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>
                </div>
            </div>


            <div>
                <div class="col-sm-12 col-lg-12">
                    <div class="form-group">
                        <label asp-for="Bio">Bio </label>
                        <textarea asp-for="Bio" class="form-control" placeholder="Bio"></textarea>
                    </div>
                </div>
                <div class="col-sm-12 col-lg-6">
                    <div class="form-group">
                        <label asp-for="IsActive">Status </label>
                        <div>
                            <label>
                                <input type="radio" asp-for="IsActive" value="true" /> Active
                            </label>
                            &nbsp;
                            <label>
                                <input type="radio" asp-for="IsActive" value="false" /> Inactive
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button name="btnUpdate" type="submit" class="btn btn-primary btnaction" id="btnUpdate" value="Update">
                    Update
                </button>
                <a asp-action="Index" class="btn btn-custom m-1">Back</a>
            </div>
        </form>
    </div>
</div>
@section Scripts {
    <script src="@Url.Content("~/js/user-bundle.js")"></script>
    <script src="@Url.Content("~/js/custom/frontuser.js")" type="text/javascript"></script>

    <script>
        $(function(){
          const maxSizeMB = @GlobalCode.ImageSize;
          const maxSizeBytes = maxSizeMB * 1024 * 1024;
          const allowedImageExtensions = @Html.Raw(Json.Serialize(GlobalCode.AllowImgFileExt.Select(ext => ext.ToLower()).Distinct()));

          $("#Image").on("change", function(e) {
            const file = this.files[0];
            $("#Image-error").html("");

            if (!file) {
              $("#Image-preview").hide();
              return;
            }

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!allowedImageExtensions.includes(fileExtension)) {
                $("#Image-error").html("Only images with .jpg, .jpeg, .png & .bmp extensions are allowed.");
                $(this).val("");
                $("#Image-preview").hide();
                return;
            }

            if (file.size > maxSizeBytes) {
              $("#Image-error").html("Image must be under " + maxSizeMB + " MB.");
              $("#Image-preview").hide();
              return;
            }

            const reader = new FileReader();
            reader.onload = function(evt) {
              $("#Image-preview-img").attr("src", evt.target.result);
              $("#Image-preview").show();
            };
            reader.readAsDataURL(file);
          });

          $("#remove-image").on("click", function(){
              debugger;
              var imagePath = $("#StrImage").val();
              if(imagePath.length > 1){
                  deletePrice();
              }
              else{
                const fileInput = $('input[type="file"][asp-for="Image"]');
                const previewContainer = $('#Image-preview');
                const previewImg = $('#Image-preview-img');
                $("#Image").val('');
                previewImg.attr('src', '#');
                previewContainer.hide();
              }
          });

            function deletePrice() {
                const Id = $("#Id").val();
                    showConfirmation("Do you want to delete this Profile Picture?", 'Yes').then((result) => {
                        if (result.value) {
                            $.ajax({
                                url: Url.Action("DeleteImage", "FrontUser"),
                                type: 'Get',
                                data: { Id: Id },
                                success: function (response) {
                                    if (response.success == true) {
                                        toastMsg(response.msg, true);
                                        window.location.reload();
                                    }
                                    else {
                                        toastMsg(response.msg, false);
                                    }
                                }
                            })
                            return true;
                        }
                        else {
                            return false;
                        }
                    })
            }

            const fileInput = $('input[type="file"][asp-for="Image"]');
            const previewContainer = $('#Image-preview');
            const previewImg = $('#Image-preview-img');
            const removeBtn = $('#remove-image');

            fileInput.on('change', function (e) {
                const file = this.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.attr('src', e.target.result);
                        previewContainer.show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.hide();
                    previewImg.attr('src', '#');
                }
            });

            removeBtn.on('click', function () {
                fileInput.val('');
                previewImg.attr('src', '#');
                previewContainer.hide();
            });

        });

    </script>
}